#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

cleanup() {
  echo "==> Cleaning up..."
  cd "$SCRIPT_DIR"
  docker compose down --volumes --remove-orphans 2>/dev/null || true
}

trap cleanup EXIT

cd "$SCRIPT_DIR"

echo "==> Building and starting test server..."
docker compose up -d --build

echo "==> Waiting for SSH to be ready..."
sleep 2

# Test SSH connection
echo "==> Testing SSH connection as root..."
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 root@127.0.0.1 "echo 'SSH connection successful'"

echo "==> Running kamal-provision..."
cd "$PROJECT_DIR"
bundle exec exe/kamal-provision provision -c test/docker/config.yml

echo "==> Verifying user was created..."
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 root@127.0.0.1 "id kamal && groups kamal"

echo "==> Testing SSH as provisioned user..."
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 kamal@127.0.0.1 "echo 'SSH as kamal successful!'"

echo "==> All tests passed!"
